name: SonarCloud Scan Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonarcloud_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Run SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Export SonarCloud Report to JSON
        run: |
          mkdir -p /tmp/sonar
          curl -X GET -u "${{ secrets.SONAR_TOKEN }}:" "https://sonarcloud.io/api/issues/search?componentKeys=mekaizen_projectdevsecops&types=BUG,VULNERABILITY,CODE_SMELL&ps=500" > /tmp/sonar/sonar-report.json
          # Check if JSON is valid
          if ! jq empty /tmp/sonar/sonar-report.json > /dev/null 2>&1; then
            echo "Error: Received invalid JSON from SonarCloud API"
            cat /tmp/sonar/sonar-report.json
            exit 1
          fi

      - name: Convert JSON to HTML with Chart
        run: |
          {
            echo "<html><head><style>"
            echo "body { font-family: Arial, sans-serif; margin: 20px; }"
            echo "h2 { color: #4CAF50; }"
            echo "h3 { margin-top: 20px; }"
            echo "ul { list-style-type: none; padding: 0; }"
            echo "li { margin: 10px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }"
            echo ".severity-HIGH { color: #ff4d4d; font-weight: bold; }"
            echo ".severity-MEDIUM { color: #0066cc; }"
            echo ".severity-LOW { color: #666666; }"
            echo "</style><script src='https://cdn.jsdelivr.net/npm/chart.js'></script></head><body>"
            echo "<h2>SonarCloud Issues Report</h2>"
          } > /tmp/sonar/sonar-report.html

          # Initialize JavaScript object for chart data
          echo "<script>const issueData = {HIGH: 0, MEDIUM: 0, LOW: 0};</script>" >> /tmp/sonar/sonar-report.html

          # Categorize issues and write to HTML file
          {
            echo "<h3>High Severity Issues</h3><ul>"
            jq -r '.issues[] | select(.severity == "BLOCKER" or .severity == "CRITICAL") | "<li class=\"severity-HIGH\">\(.message) - Severity: HIGH</li>"' /tmp/sonar/sonar-report.json
            echo "</ul><h3>Medium Severity Issues</h3><ul>"
            jq -r '.issues[] | select(.severity == "MAJOR") | "<li class=\"severity-MEDIUM\">\(.message) - Severity: MEDIUM</li>"' /tmp/sonar/sonar-report.json
            echo "</ul><h3>Low Severity Issues</h3><ul>"
            jq -r '.issues[] | select(.severity == "MINOR") | "<li class=\"severity-LOW\">\(.message) - Severity: LOW</li>"' /tmp/sonar/sonar-report.json
            echo "</ul>"
          } >> /tmp/sonar/sonar-report.html

          # Add JavaScript Chart and close HTML
          {
            echo "<h3>Severity Distribution</h3><canvas id='severityChart' width='400' height='400'></canvas>"
            echo "<script>"
            echo "const data = { labels: ['High', 'Medium', 'Low'], datasets: [{"
            echo "label: 'Issue Severity Distribution', data: [issueData.HIGH, issueData.MEDIUM, issueData.LOW],"
            echo "backgroundColor: ['#ff4d4d', '#0066cc', '#666666'], hoverOffset: 4 }]};"
            echo "const config = { type: 'pie', data: data };"
            echo "new Chart(document.getElementById('severityChart'), config);"
            echo "</script></body></html>"
          } >> /tmp/sonar/sonar-report.html

      - name: Verify HTML Report Completeness
        run: |
          # Display the last few lines for verification
          echo "Verifying HTML Report Completeness:"
          tail -n 10 /tmp/sonar/sonar-report.html

          # Check for </html> closing tag
          if ! tail -n 1 /tmp/sonar/sonar-report.html | grep -q "</html>"; then
            echo "Error: HTML report is incomplete."
            exit 1
          fi

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: SonarCloud HTML Report
          path: /tmp/sonar/sonar-report.html
          
 
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Build Docker Image
        run: docker build -t my-python-app .

      - name: Start Application
        run: docker run -d --name my-app -p 8080:8080 my-python-app

      - name: Create Report Directory
        run: mkdir -p security-reports/zap-reports && chmod 777 security-reports/zap-reports

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: "http://localhost:8080"
          cmd_options: "-r security-reports/zap-reports/zap_report.html -J security-reports/zap-reports/zap_out.json -w security-reports/zap-reports/zap_report.md"
          docker_name: "ghcr.io/zaproxy/zaproxy:weekly"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZAP Reports as Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: zap_reports
          path: security-reports/zap-reports

      - name: Stop Application
        run: docker stop my-app && docker rm my-app
        
        
  sca_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Download OWASP Dependency Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v7.1.1/dependency-check-7.1.1-release.zip
          unzip dependency-check-7.1.1-release.zip -d dependency-check
          chmod +x dependency-check/dependency-check/bin/dependency-check.sh

      - name: Run OWASP Dependency Check
        run: |
          mkdir -p security-reports
          dependency-check/dependency-check/bin/dependency-check.sh --project "My Project SCA" \
          --scan $(pwd) --format "HTML" --out $(pwd)/security-reports/dependency-check-report.html

      - name: Upload Dependency Check Report as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-report
          path: security-reports/dependency-check-report.html

  combine_reports:
    runs-on: ubuntu-latest
    needs: [sonarcloud_scan, zap_scan, sca_scan]
    steps:
      - name: Download SonarQube Report
        uses: actions/download-artifact@v3
        with:
          name: SonarCloud HTML Report
          path: security-reports

      - name: Download ZAP Report
        uses: actions/download-artifact@v3
        with:
          name: zap_reports
          path: security-reports

      - name: Download Dependency Check Report
        uses: actions/download-artifact@v3
        with:
          name: dependency-check-report
          path: security-reports

      - name: Generate Consolidated HTML Report
        run: |
          echo "<html><head><style>body { font-family: Arial, sans-serif; } h1, h2 { color: #4CAF50; }</style></head><body><h1>Consolidated Security Report</h1>" > security-reports/consolidated-report.html

          # Add SonarQube HTML Report if available
          if [[ -f "security-reports/sonar-report.html" ]]; then
            echo "<h2>SonarQube SAST Report</h2>" >> security-reports/consolidated-report.html
            cat security-reports/sonar-report.html >> security-reports/consolidated-report.html
          else
            echo "<p>SonarQube report not found!</p>" >> security-reports/consolidated-report.html
          fi

          # Add ZAP HTML Report if available
          if [[ -f "security-reports/zap-reports/zap_report.html" ]]; then
            echo "<h2>OWASP ZAP DAST Report</h2>" >> security
